<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RogueLX - Movie PWA</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a dark, cinematic theme */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            /* Deep Indigo/Purple Accent (#6C47DB) on Dark Grey */
            --primary: #6C47DB; 
            --background: #121212; /* Dark Grey background */
            --card: #1e1e1e; /* Slightly lighter card background */
            --text-light: #f5f5f5;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-light);
        }

        /* Customize Tailwind config for the theme colors */
        .tailwind-config {
            display: none;
        }

        /* Scrollbar styles for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--card);
        }
        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        /* Custom scrollbar for horizontal rows */
        .custom-scroll {
            /* Firefox style */
            scrollbar-color: var(--primary) var(--card);
            scrollbar-width: thin;
            -ms-overflow-style: none; /* IE and Edge */
        }
        /* Webkit styles (Chrome, Safari) */
        .custom-scroll::-webkit-scrollbar {
            height: 8px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: var(--card);
        }

        /* Video player specific styles */
        .video-container {
            width: 100%;
            height: 0;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            position: relative;
            background-color: #000;
        }

        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Custom control bar appearance */
        .video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0));
            padding: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .video-container:hover .video-controls,
        .video-controls:focus-within {
            opacity: 1;
        }

        /* Progress Bar Styling */
        #progressBar {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: #555;
            cursor: pointer;
            border-radius: 3px;
            margin-bottom: 0.5rem;
        }

        /* Customize track and thumb for progress bar */
        #progressBar::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            transition: background 0.2s;
        }
        #progressBar::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: none;
        }

        #progressBar::-webkit-slider-runnable-track {
            background: #555;
            border-radius: 3px;
        }
        #progressBar::-moz-range-track {
            background: #555;
            border-radius: 3px;
        }
        
        /* CSS for the install prompt button transition */
        #installPrompt {
            transition: opacity 0.3s ease-in-out;
        }

        /* Toast Message for Downloads/Feedback */
        #messageBox {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
    </style>
    <!-- PWA Manifest Link -->
    <link id="manifestLink" rel="manifest" href="">
</head>
<body class="min-h-screen">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: 'var(--primary)',
                        background: 'var(--background)',
                        card: 'var(--card)',
                    },
                },
            },
        }
    </script>

    <!-- Header & Navigation -->
    <header class="sticky top-0 z-40 bg-background/95 backdrop-blur-sm shadow-xl p-4 md:p-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
        <!-- Logo and Home Button Group -->
        <div class="flex items-center space-x-4 md:flex-shrink-0">
            <!-- Logo -->
            <h1 class="text-3xl font-extrabold text-primary tracking-widest">ROGUE<span class="text-white">LX</span></h1>
            
            <!-- NEW Home Button -->
            <button id="homeButton" class="p-2 rounded-full bg-card hover:bg-primary/50 text-white transition duration-200" 
                    aria-label="Go to Home">
                <!-- Home Icon SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
            </button>
        </div>
        
        <!-- Search Bar and Controls Group -->
        <div class="flex items-center space-x-4 w-full md:w-auto md:flex-grow md:justify-end">
            
            <!-- Search Input -->
            <input type="text" id="searchInput" placeholder="Search movies, genres..."
                class="flex-grow p-2 rounded-lg border-2 border-primary/50 bg-card text-text-light placeholder-gray-500 focus:outline-none focus:border-primary transition duration-200 md:max-w-md">
            
            <!-- User Info and Auth/Install Buttons -->
            <div id="authAndUtility" class="flex items-center space-x-2 md:space-x-3 flex-shrink-0">
                <p id="userIdDisplay" class="text-xs md:text-sm font-mono text-gray-400 truncate max-w-[5rem] md:max-w-xs hidden"></p>

                <!-- Notification Icon -->
                <button id="notificationButton" class="p-2 rounded-full bg-card hover:bg-primary/50 text-white transition duration-200" 
                        aria-label="Notifications">
                    <!-- Bell Icon SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                    </svg>
                </button>
                
                <!-- Profile Icon (Linked to openProfileScreen) -->
                <button id="profileButton" class="p-2 rounded-full bg-card hover:bg-primary/50 text-white transition duration-200" 
                        aria-label="User Profile">
                    <!-- User Icon SVG (Simple circle with person) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                </button>

                <button id="signInOutButton" 
                        class="bg-gray-600 hover:bg-opacity-80 text-white font-semibold py-2 px-3 text-sm rounded-lg shadow-lg transition duration-300">
                    Sign In
                </button>
                
                <button id="installPrompt" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-3 text-sm rounded-lg shadow-lg hidden opacity-0 transition duration-300">
                    Install
                </button>
            </div>
        </div>
    </header>

    <!-- Notification Screen (New UI Component) -->
    <section id="notificationScreen" class="fixed inset-0 z-30 bg-background/95 backdrop-blur-md hidden overflow-y-auto">
        <div class="max-w-xl mx-auto p-4 md:p-8">
            <div class="flex items-center space-x-4 mb-8 pt-4">
                <button id="closeNotificationButton" class="p-2 text-white hover:text-primary transition" aria-label="Close notifications">
                    <!-- Back Arrow SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                </button>
                <h2 class="text-3xl md:text-4xl font-bold text-white">Notifications</h2>
            </div>

            <div id="notificationsList" class="space-y-4">
                <!-- Notifications will be injected here -->
            </div>
            <p id="noNotifications" class="text-gray-500 text-center py-10 hidden">You're all caught up! No new notifications.</p>
        </div>
    </section>

    <!-- Profile Screen -->
    <section id="profileScreen" class="fixed inset-0 z-20 bg-background/95 backdrop-blur-md hidden overflow-y-auto">
        <div class="max-w-4xl mx-auto p-4 md:p-8">
            <!-- Back Button and Title -->
            <div class="flex items-center space-x-4 mb-8 pt-4">
                <button id="closeProfileButton" class="p-2 text-white hover:text-primary transition" aria-label="Go back">
                    <!-- Back Arrow SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                </button>
                <h2 class="text-3xl md:text-4xl font-bold text-white">My Profile</h2>
            </div>

            <!-- User Info Card -->
            <div class="bg-card p-6 md:p-8 rounded-xl shadow-2xl flex items-center space-x-6 border border-primary/20 mb-10">
                <!-- Profile Picture Placeholder (Initial 'U') -->
                <div class="w-20 h-20 md:w-24 md:h-24 bg-primary rounded-full flex items-center justify-center text-4xl font-bold text-white flex-shrink-0">
                    U
                </div>
                <div>
                    <p id="profileUserName" class="text-xl md:text-3xl font-bold text-white">User</p>
                    <p id="profileUserId" class="text-sm md:text-base text-gray-400 font-mono break-all"></p>
                    <button class="mt-2 text-sm text-primary hover:text-primary/80 transition duration-200" onclick="console.log('Edit Profile Clicked')">Edit Profile</button>
                </div>
            </div>

            <!-- Settings Menu -->
            <div class="space-y-4">
                <!-- My List -->
                <button class="w-full text-left p-4 bg-card hover:bg-primary/20 rounded-xl transition duration-200 flex items-center space-x-4" onclick="console.log('My List Clicked')">
                    <!-- Bookmark/List SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                    </svg>
                    <span class="text-lg text-white font-medium flex-grow">My List</span>
                    <!-- Arrow Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                    </svg>
                </button>

                <!-- Watch History -->
                <button class="w-full text-left p-4 bg-card hover:bg-primary/20 rounded-xl transition duration-200 flex items-center space-x-4" onclick="console.log('Watch History Clicked')">
                    <!-- History/Clock SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="text-lg text-white font-medium flex-grow">Watch History</span>
                    <!-- Arrow Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                    </svg>
                </button>

                <!-- Account Settings -->
                <button class="w-full text-left p-4 bg-card hover:bg-primary/20 rounded-xl transition duration-200 flex items-center space-x-4" onclick="console.log('Account Settings Clicked')">
                    <!-- Gear/Settings SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.568.349 1.29.32 1.724-.047zM12 15a3 3 0 100-6 3 3 0 000 6z" />
                    </svg>
                    <span class="text-lg text-white font-medium flex-grow">Account Settings</span>
                    <!-- Arrow Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                    </svg>
                </button>

                <!-- Subscriptions & Billing -->
                <button class="w-full text-left p-4 bg-card hover:bg-primary/20 rounded-xl transition duration-200 flex items-center space-x-4" onclick="console.log('Subscriptions Clicked')">
                    <!-- Credit Card/Wallet SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 10a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2v-8zM7 14h10m-5-4v-1a3 3 0 00-3-3H9a3 3 0 00-3 3v1" />
                    </svg>
                    <span class="text-lg text-white font-medium flex-grow">Subscriptions & Billing</span>
                    <!-- Arrow Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                    </svg>
                </button>

                <!-- Help & Support -->
                <button class="w-full text-left p-4 bg-card hover:bg-primary/20 rounded-xl transition duration-200 flex items-center space-x-4" onclick="console.log('Help & Support Clicked')">
                    <!-- Question Mark/Support SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18H15.75m-7.5 0c-.828 0-1.5-.672-1.5-1.5V6.75A1.5 1.5 0 018.25 5h7.5A1.5 1.5 0 0117.25 6.75v9.75c0 .828-.672 1.5-1.5 1.5z" />
                    </svg>
                    <span class="text-lg text-white font-medium flex-grow">Help & Support</span>
                    <!-- Arrow Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>

            <!-- Divider -->
            <hr class="border-gray-700 my-10">

            <!-- Sign Out Button -->
            <button id="profileSignOutButton" class="w-full p-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl shadow-lg transition duration-200 flex items-center justify-center space-x-2">
                <!-- Sign Out SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                <span>Sign Out</span>
            </button>
        </div>
    </section>

    <!-- Authentication Screen -->
    <section id="authScreen" class="fixed inset-0 z-20 bg-background/95 backdrop-blur-md flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-card p-8 rounded-xl shadow-2xl border border-primary/20">
            <h2 id="authTitle" class="text-3xl font-bold text-primary mb-6 text-center">Sign In</h2>
            
            <div id="authMessage" class="text-primary/70 mb-4 text-center hidden"></div> <!-- Used primary color for errors/warnings -->

            <form id="authForm" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-400">Email</label>
                    <input type="email" id="email" required
                           class="mt-1 block w-full p-3 rounded-lg bg-background border border-gray-600 text-text-light focus:ring-primary focus:border-primary">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-400">Password</label>
                    <input type="password" id="password" required
                           class="mt-1 block w-full p-3 rounded-lg bg-background border border-gray-600 text-text-light focus:ring-primary focus:border-primary">
                </div>
                <button type="submit" id="authSubmitButton" class="w-full p-3 bg-primary hover:bg-opacity-80 text-white font-bold rounded-lg shadow-md transition duration-200">
                    Sign In
                </button>
            </form>

            <div class="mt-6 text-center">
                <button id="toggleAuthMode" class="text-sm text-primary hover:underline">
                    Don't have an account? Sign Up
                </button>
            </div>
        </div>
    </section>

    <!-- Main Content Area -->
    <div id="mainAppContent" class="hidden">
        <main id="mainContent" class="container mx-auto p-0 pb-10">
            
            <!-- 1. Hero Banner Section -->
            <section id="heroBanner" class="w-full h-[40vh] md:h-[60vh] bg-cover bg-center relative rounded-b-xl overflow-hidden shadow-2xl" 
                    style="background-image: url('https://placehold.co/1920x1080/3C248A/FFFFFF?text=Featured+Blockbuster+Movie');">
                <!-- Hero content overlay -->
                <div class="absolute inset-0 bg-gradient-to-t from-background via-black/40 to-transparent p-6 md:p-12 flex flex-col justify-end">
                    <p class="text-sm md:text-base text-gray-300 mb-2 font-medium">New Release | Action Thriller</p>
                    <h2 class="text-3xl md:text-6xl font-black text-white drop-shadow-lg">The Quantum Rift</h2>
                    <p class="text-base md:text-lg text-gray-200 mt-2 max-w-xl hidden sm:block">A physicist races against time to close an accidental tear in the fabric of spacetime, before reality collapses.</p>
                    <button id="heroPlayButton" class="mt-4 w-fit px-6 py-2 bg-primary hover:bg-opacity-80 text-white font-bold rounded-lg transition duration-200 shadow-xl flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                        </svg>
                        Play Now
                    </button>
                </div>
            </section>

            <!-- 2. Scrolling Movie Rows Container -->
            
            <!-- Trending Now Row -->
            <section id="trendingSection" class="mt-8 md:mt-12 px-4 md:px-6">
                <h2 class="text-2xl font-bold mb-4">Trending Now</h2>
                <div id="movieRowTrending" class="flex space-x-4 overflow-x-scroll pb-4 custom-scroll">
                    <!-- Content will be injected here -->
                </div>
            </section>

            <!-- Sci-Fi & Action Row -->
            <section id="scifiSection" class="mt-8 md:mt-12 px-4 md:px-6">
                <h2 class="text-2xl font-bold mb-4">Sci-Fi & Action</h2>
                <div id="movieRowSciFi" class="flex space-x-4 overflow-x-scroll pb-4 custom-scroll">
                    <!-- Content will be injected here -->
                </div>
            </section>

            <!-- Placeholder for dynamic search results grid -->
            <div id="searchResultsContainer" class="p-4 md:p-6 hidden">
                <!-- Search Results will be injected here -->
            </div>

        </main>
    </div>

    <!-- Movie Detail / Streaming Modal -->
    <div id="movieModal" class="fixed inset-0 bg-black bg-opacity-95 z-50 hidden overflow-y-auto p-4">
        <div class="max-w-4xl mx-auto rounded-xl shadow-2xl bg-card border-2 border-primary/20 mt-12 mb-12">
            <!-- Close Button -->
            <button id="closeModalButton" class="absolute top-4 right-4 text-white text-3xl font-bold p-2 hover:text-primary transition duration-200 z-50">
                &times;
            </button>

            <!-- Video Player -->
            <div id="videoContainer" class="video-container rounded-t-xl">
                <!-- The mock video element and controls will be injected here by JS -->
            </div>

            <!-- Movie Details -->
            <div class="p-6 md:p-8 space-y-4">
                <h3 id="modalTitle" class="text-3xl md:text-4xl font-extrabold text-primary">Title</h3>
                <p id="modalYear" class="text-lg text-gray-400"></p>
                <p id="modalDescription" class="text-base leading-relaxed text-gray-300"></p>
                <div class="flex flex-wrap gap-2 text-sm">
                    <span id="modalGenre" class="bg-primary/20 text-primary font-medium px-3 py-1 rounded-full"></span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Global Message Box (Toast) -->
    <div id="messageBox" class="fixed bottom-4 left-1/2 -translate-x-1/2 p-3 bg-primary/90 text-white rounded-lg shadow-2xl text-center z-50 opacity-0 pointer-events-none">
        <!-- Message content will be injected here -->
    </div>

    <!-- Video Controls Template (Invisible in HTML, used by JS) -->
    <div id="customControls" class="video-controls rounded-b-xl hidden">
        <input type="range" id="progressBar" min="0" max="100" value="0">
        <div class="flex justify-between items-center text-white">
            <div class="flex items-center space-x-3">
                <!-- Play/Pause Button -->
                <button id="playPauseButton" aria-label="Play or Pause">
                    <!-- Pause Icon -->
                    <svg id="pauseIcon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-primary hover:text-white transition" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    <!-- Play Icon -->
                    <svg id="playIcon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 hover:text-primary/80 transition hidden" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                </button>
                
                <!-- Volume Control -->
                <div class="flex items-center space-x-1">
                    <button id="muteButton" aria-label="Mute or Unmute">
                        <!-- Volume High Icon -->
                        <svg id="volumeHigh" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-300 hover:text-primary transition" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.625 5.25a1.75 1.75 0 00-3.5 0v1.5a.75.75 0 001.5 0V6.75a.25.25 0 01.5 0v.5a.75.75 0 001.5 0v-.5a1.75 1.75 0 00-1.75-1.75zM16.625 7.25a1.75 1.75 0 00-3.5 0v1.5a.75.75 0 001.5 0V8.75a.25.25 0 01.5 0v.5a.75.75 0 001.5 0v-.5a1.75 1.75 0 00-1.75-1.75z" clip-rule="evenodd" />
                        </svg>
                        <!-- Volume Mute Icon (initially hidden) -->
                        <svg id="volumeMute" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary hidden" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zm1.472 6.697a.75.75 0 10-1.06-1.06L12 10.94l-2.207-2.207a.75.75 0 10-1.06 1.06L10.94 12l-2.207 2.207a.75.75 0 101.06 1.06L12 13.06l2.207 2.207a.75.75 0 001.06-1.06L13.06 12l2.207-2.207a.75.75 0 00-1.06-1.06L12 10.94l-2.207-2.207z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <input type="range" id="volumeBar" min="0" max="100" value="70" class="w-16 h-1 rounded-lg cursor-pointer bg-gray-500 appearance-none slider-thumb-primary">
                </div>
                
                <!-- Time Display -->
                <span id="timeDisplay" class="text-sm font-mono text-gray-300">00:00 / 00:00</span>
            </div>
            
            <!-- Fullscreen Button -->
            <button id="fullscreenButton" class="p-1 rounded-lg text-gray-300 hover:text-primary transition" aria-label="Toggle Fullscreen">
                <!-- Fullscreen SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-5v4m0 0h-4m4 0l-5 5m-5 8v4m0 0H7m0 0l-5-5m11 5h4m0 0v-4m0 4l-5-5" />
                </svg>
            </button>
        </div>
    </div>

    <!-- JavaScript for PWA Logic, Data, and Interactivity -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, deleteDoc, 
            onSnapshot, collection, setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        // Global Firebase variables
        let app, db, auth;
        let currentUserId = null;
        let isAuthReady = false;
        
        // Favorites state synchronized with Firestore
        let favorites = []; 
        const FAVORITES_COLLECTION_NAME = 'userFavorites';

        // Configs provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- UI Element References ---
        const installPromptButton = document.getElementById('installPrompt');
        const manifestLink = document.getElementById('manifestLink');
        const searchInput = document.getElementById('searchInput');
        const movieModal = document.getElementById('movieModal');
        const heroBanner = document.getElementById('heroBanner');
        const movieRowTrending = document.getElementById('movieRowTrending');
        const movieRowSciFi = document.getElementById('movieRowSciFi');
        const trendingSection = document.getElementById('trendingSection');
        const scifiSection = document.getElementById('scifiSection');
        let searchResultsContainer = document.getElementById('searchResultsContainer');
        const profileButton = document.getElementById('profileButton'); 
        const messageBox = document.getElementById('messageBox'); // New Ref for Toast
        
        // Authentication UI Refs
        const authScreen = document.getElementById('authScreen');
        const mainAppContent = document.getElementById('mainAppContent');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const signInOutButton = document.getElementById('signInOutButton');
        const authTitle = document.getElementById('authTitle');
        const authSubmitButton = document.getElementById('authSubmitButton');
        const toggleAuthModeButton = document.getElementById('toggleAuthMode');
        const authMessage = document.getElementById('authMessage');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authForm = document.getElementById('authForm'); 
        
        // Modal and Hero Refs
        const closeModalButton = document.getElementById('closeModalButton'); 
        const heroPlayButton = document.getElementById('heroPlayButton');     
        const videoContainer = document.getElementById('videoContainer'); 

        // Profile Screen Refs
        const profileScreen = document.getElementById('profileScreen');
        const profileUserName = document.getElementById('profileUserName');
        const profileUserId = document.getElementById('profileUserId');
        const closeProfileButton = document.getElementById('closeProfileButton');
        const profileSignOutButton = document.getElementById('profileSignOutButton');

        // Notification Screen Refs
        const notificationButton = document.getElementById('notificationButton');
        const notificationScreen = document.getElementById('notificationScreen');
        const closeNotificationButton = document.getElementById('closeNotificationButton');
        const notificationsList = document.getElementById('notificationsList');
        const noNotifications = document.getElementById('noNotifications');
        
        // NEW Home Button Ref
        const homeButton = document.getElementById('homeButton');

        let videoElement = null; 
        let CUSTOM_CONTROLS_HTML_STORE = ''; 

        let isSignInMode = true; 

        // --- Mock Data ---
        const MOCK_VIDEO_URL = "https://www.w3schools.com/html/mov_bbb.mp4"; // Sample MP4 video
        const MOCK_MOVIES = [
            { id: 1, title: "The Quantum Rift", year: 2024, genre: "Sci-Fi", category: "Trending", description: "A physicist races against time to close an accidental tear in the fabric of spacetime.", poster: "https://placehold.co/400x600/3C248A/f8fafc?text=Quantum+Rift" },
            { id: 2, title: "The Silent Watcher", year: 2023, genre: "Thriller", category: "Trending", description: "A detective hunts a killer who only strikes during city-wide blackouts.", poster: "https://placehold.co/400x600/2C2C2C/f8fafc?text=Watcher" },
            { id: 3, title: "Dragon's Ascent", year: 2022, genre: "Fantasy", category: "Fantasy", description: "A young hero discovers a hidden lineage and must tame a dragon.", poster: "https://placehold.co/400x600/6C47DB/f8fafc?text=Dragon" },
            { id: 4, title: "The Last Laugh", year: 2024, genre: "Comedy", category: "Comedy", description: "Two stand-up comedians accidentally become federal witnesses in a mob trial.", poster: "https://placehold.co/400x600/1E1E1E/f8fafc?text=Comedy" },
            { id: 5, title: "Cybernetic Heart", year: 2021, genre: "Romance", category: "Sci-Fi", description: "A roboticist falls in love with the AI he created to manage his life.", poster: "https://placehold.co/400x600/3C248A/f8fafc?text=Cybernetic" },
            { id: 6, title: "Historical Echoes", year: 2020, genre: "Documentary", category: "Trending", description: "An in-depth look at historical events that shaped the modern world.", poster: "https://placehold.co/400x600/6C47DB/f8fafc?text=History" },
            { id: 7, title: "Neon Streets", year: 2023, genre: "Action", category: "Sci-Fi", description: "A former spy must return to the grimy, neon-lit streets to rescue his mentor.", poster: "https://placehold.co/400x600/2C2C2C/f8fafc?text=Neon+Action" },
            { id: 8, title: "Deep Sea Terror", year: 2022, genre: "Horror", category: "Horror", description: "A deep-sea submersible crew encounters a terrifying, unknown entity.", poster: "https://placehold.co/400x600/3C248A/f8fafc?text=Terror" },
            { id: 9, title: "The Architect's Dilemma", year: 2024, genre: "Drama", category: "Trending", description: "A successful architect must choose between his career and his family's safety.", poster: "https://placehold.co/400x600/1E1E1E/f8fafc?text=Drama" },
            { id: 10, title: "Galactic Run", year: 2024, genre: "Sci-Fi", category: "Sci-Fi", description: "A group of mercenaries transports illegal cargo across the galaxy.", poster: "https://placehold.co/400x600/6C47DB/f8fafc?text=Galactic+Run" },
            { id: 11, title: "High Speed Chase", year: 2023, genre: "Action", category: "Sci-Fi", description: "An exhilarating chase through a future cityscape.", poster: "https://placehold.co/400x600/2C2C2C/f8fafc?text=Chase" },
            { id: 12, title: "Ancient Secrets", year: 2021, genre: "Adventure", category: "Trending", description: "An archaeologist discovers a map to a lost civilization.", poster: "https://placehold.co/400x600/3C248A/f8fafc?text=Secrets" },
        ];
        
        const MOCK_NOTIFICATIONS = [
            { id: 1, type: 'new', title: 'New Release: The Lunar Gambit', time: '5 minutes ago', detail: 'The highly anticipated sci-fi thriller is now streaming!' },
            { id: 2, type: 'promo', title: 'Weekend Watchlist: 20% Off', time: '1 hour ago', detail: 'Rent any 4K title this weekend and get 20% off your next purchase.' },
            { id: 3, type: 'update', title: 'App Update Available', time: '1 day ago', detail: "We've released a new version with improved performance and stability." },
        ];


        // --- Firebase Initialization and Auth ---

        async function setupFirebase() {
            setLogLevel('Debug');
            if (!Object.keys(firebaseConfig).length) {
                console.error("Firebase config is missing. Authentication cannot be initialized.");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Initial Authentication Check
                await new Promise((resolve) => {
                    onAuthStateChanged(auth, async (user) => {
                        currentUserId = user ? user.uid : null;
                        isAuthReady = true;
                        updateAppUI(user);
                        if (user) {
                            listenForFavorites();
                        }
                        resolve();
                    });
                });

                // Sign in with custom token if available (Canvas environment default)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else if (!auth.currentUser) {
                    // Fallback to anonymous sign-in if no custom token and not already authenticated
                    await signInAnonymously(auth);
                }
                
            } catch (error) {
                console.error("Firebase setup failed:", error);
            }
        }

        function updateAppUI(user) {
            // Close any open screens/modals first
            closeProfileScreen(); 
            closeNotificationScreen();
            closeModal();
            
            if (user) {
                mainAppContent.classList.remove('hidden');
                authScreen.classList.add('hidden');
                
                signInOutButton.textContent = 'Sign Out';
                signInOutButton.classList.add('bg-primary'); 
                signInOutButton.classList.remove('bg-gray-600'); 

                const shortId = user.uid.substring(0, 8) + '...';
                userIdDisplay.textContent = `User: ${shortId}`;
                userIdDisplay.classList.remove('hidden');
                
                profileUserName.textContent = user.email ? user.email.split('@')[0] : 'Guest User';
                profileUserId.textContent = user.uid;

                if (isAuthReady) {
                    renderHomePage();
                }
            } else {
                mainAppContent.classList.add('hidden');
                authScreen.classList.remove('hidden');

                signInOutButton.textContent = 'Sign In';
                signInOutButton.classList.remove('bg-primary');
                signInOutButton.classList.add('bg-gray-600'); 

                userIdDisplay.classList.add('hidden');
                userIdDisplay.textContent = ''; 
                
                // Clear favorites state when logged out
                favorites = []; 
                renderHomePage(); // Render the homepage to update card icons
            }
        }

        // --- Authentication Handlers (omitted for brevity, assume unchanged) ---

        function toggleAuthMode() {
            isSignInMode = !isSignInMode;
            authTitle.textContent = isSignInMode ? 'Sign In' : 'Sign Up';
            authSubmitButton.textContent = isSignInMode ? 'Sign In' : 'Sign Up';
            toggleAuthModeButton.textContent = isSignInMode 
                ? "Don't have an account? Sign Up" 
                : "Already have an account? Sign In";
            authMessage.classList.add('hidden');
            authMessage.textContent = '';
        }

        function displayAuthError(message) {
            authMessage.textContent = message;
            authMessage.classList.remove('hidden');
        }

        async function submitAuthForm() {
            const email = emailInput.value;
            const password = passwordInput.value;
            authMessage.classList.add('hidden');
            
            if (password.length < 6) {
                displayAuthError("Password must be at least 6 characters long.");
                return;
            }

            try {
                if (isSignInMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                console.error("Authentication error:", error.code, error.message);
                
                let userFriendlyMessage = "An unknown error occurred.";
                if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    userFriendlyMessage = "Invalid email or password.";
                } else if (error.code === 'auth/email-already-in-use') {
                    userFriendlyMessage = "Email already in use. Try signing in instead.";
                } else if (error.code === 'auth/invalid-email') {
                    userFriendlyMessage = "Invalid email address format.";
                } else if (error.code === 'auth/weak-password') {
                    userFriendlyMessage = "Password is too weak. Must be at least 6 characters.";
                }
                displayAuthError(userFriendlyMessage);
            }
        }

        function handleSignOutOrAuthClick() {
            if (auth && auth.currentUser) {
                signOut(auth).catch((error) => {
                    console.error("Sign Out Error:", error);
                });
            } else {
                authScreen.classList.remove('hidden');
            }
        }

        // --- Toast Message Utility (New) ---

        let messageTimeout;
        function showTempMessage(message) {
            clearTimeout(messageTimeout);
            messageBox.textContent = message;
            messageBox.classList.remove('opacity-0', 'pointer-events-none');
            
            messageTimeout = setTimeout(() => {
                messageBox.classList.add('opacity-0', 'pointer-events-none');
            }, 3000);
        }

        // --- Navigation Handlers ---

        function goToHome() {
            closeModal(); // Close video modal
            closeProfileScreen(); // Close profile screen
            closeNotificationScreen(); // Close notification screen

            // Clear search and ensure home view is rendered
            searchInput.value = '';
            filterMovies(); // filterMovies calls renderHomePage when search is empty
            
            if (currentUserId) {
                mainAppContent.classList.remove('hidden');
            }
        }

        // --- Notification Handlers (New) ---

        function renderNotifications() {
            notificationsList.innerHTML = '';
            
            if (MOCK_NOTIFICATIONS.length === 0) {
                noNotifications.classList.remove('hidden');
                return;
            }
            noNotifications.classList.add('hidden');

            MOCK_NOTIFICATIONS.forEach(notif => {
                const item = document.createElement('div');
                item.className = 'bg-card p-4 rounded-xl shadow-lg border-l-4 border-primary/50 hover:bg-card/80 cursor-pointer transition';
                item.innerHTML = `
                    <h3 class="text-lg font-bold text-white">${notif.title}</h3>
                    <p class="text-sm text-gray-400 mt-1">${notif.detail}</p>
                    <p class="text-xs text-primary mt-2">${notif.time}</p>
                `;
                notificationsList.appendChild(item);
            });
        }

        function openNotificationScreen() {
            if (!currentUserId) {
                showTempMessage("Please sign in to view your notifications.");
                return;
            }

            // Hide other screens
            closeProfileScreen();
            
            renderNotifications();
            notificationScreen.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Hide main content if not searching
            if(searchInput.value.trim() === '') {
                mainAppContent.classList.add('hidden');
            }
        }

        function closeNotificationScreen() {
            notificationScreen.classList.add('hidden');
            document.body.style.overflow = '';
            
            // Restore main content view
            if (currentUserId && searchInput.value.trim() === '') {
                mainAppContent.classList.remove('hidden');
            }
        }


        // --- Profile Screen Handlers ---

        function openProfileScreen() {
            if (!currentUserId) return; 

            closeNotificationScreen();
            mainAppContent.classList.add('hidden');
            profileScreen.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            searchResultsContainer.classList.add('hidden');
        }

        function closeProfileScreen() {
            profileScreen.classList.add('hidden');
            document.body.style.overflow = '';
            
            if (currentUserId && searchInput.value.trim() === '') {
                mainAppContent.classList.remove('hidden');
            }
        }
        
        // --- Firestore Favorites Logic (New) ---

        function getFavoritesCollectionRef() {
            if (!db || !currentUserId) return null;
            // Private data storage path: /artifacts/{appId}/users/{userId}/{collectionName}
            return collection(db, 'artifacts', appId, 'users', currentUserId, FAVORITES_COLLECTION_NAME);
        }

        function listenForFavorites() {
            const favoritesRef = getFavoritesCollectionRef();
            if (!favoritesRef) return;

            onSnapshot(favoritesRef, (snapshot) => {
                favorites = [];
                snapshot.forEach(doc => {
                    // Store the document ID, which is the movieId, in the local state array
                    favorites.push(parseInt(doc.id)); 
                });
                
                console.log("Favorites updated:", favorites);
                // Re-render the homepage to reflect the new favorites state
                renderHomePage(); 
            }, (error) => {
                console.error("Error listening to favorites:", error);
            });
        }

        async function toggleFavorite(movieId, movieTitle) {
            if (!currentUserId || !db) {
                showTempMessage("Please sign in to save items to your list.");
                return;
            }
            
            const isFavorited = favorites.includes(movieId);
            const docRef = doc(getFavoritesCollectionRef(), String(movieId));

            try {
                if (isFavorited) {
                    await deleteDoc(docRef);
                    showTempMessage(`${movieTitle} removed from My List.`);
                } else {
                    // Store the movie ID and title in the document. The document ID is the movie ID itself.
                    await setDoc(docRef, { 
                        movieId: movieId,
                        title: movieTitle,
                        addedAt: new Date().toISOString()
                    });
                    showTempMessage(`${movieTitle} added to My List!`);
                }
            } catch (error) {
                console.error("Error toggling favorite:", error);
                showTempMessage("Error updating My List. Please try again.");
            }
        }


        // --- PWA Logic (omitted for brevity, assume unchanged) ---
        
        let deferredPrompt;
        const MANIFEST_CONTENT = {
            "name": "RogueLX PWA",
            "short_name": "RogueLX",
            "description": "Your ultimate PWA for streaming mock movies and shows.",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#121212", 
            "theme_color": "#6C47DB", 
            "icons": [
                {
                    "src": "https://placehold.co/192x192/6C47DB/FFFFFF/png?text=RL", 
                    "sizes": "192x192",
                    "type": "image/png"
                },
                {
                    "src": "https://placehold.co/512x512/6C47DB/FFFFFF/png?text=RL", 
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ]
        };

        const manifestBlob = new Blob([JSON.stringify(MANIFEST_CONTENT)], { type: 'application/json' });
        manifestLink.href = URL.createObjectURL(manifestBlob);

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installPromptButton.classList.remove('hidden');
            setTimeout(() => installPromptButton.classList.add('opacity-100'), 10);
        });

        function handleInstallClick() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    } else {
                        console.log('User dismissed the install prompt');
                    }
                    deferredPrompt = null;
                    installPromptButton.classList.remove('opacity-100');
                    setTimeout(() => installPromptButton.classList.add('hidden'), 300);
                });
            }
        }

        // --- Application UI Logic ---
        
        function renderMovieCard(movie, isGrid = false) {
            const isFavorited = favorites.includes(movie.id);
            const card = document.createElement('div');
            const sizeClass = isGrid ? 'w-full' : 'flex-shrink-0 w-32 sm:w-40 lg:w-48';
            
            card.className = `${sizeClass} group cursor-pointer rounded-xl overflow-hidden shadow-lg hover:shadow-primary/50 transition duration-300 transform hover:scale-[1.05] bg-card`;
            card.onclick = () => openModal(movie);

            const favoriteIconFill = isFavorited ? 'fill-primary' : 'fill-white/50 group-hover:fill-primary';
            
            // Attach toggleFavorite and handleDownloadClick to the buttons
            card.innerHTML = `
                <div class="relative overflow-hidden h-48 sm:h-64 lg:h-72">
                    <!-- Image -->
                    <img src="${movie.poster}" alt="${movie.title} Poster" class="w-full h-full object-cover transition duration-300 group-hover:opacity-80" onerror="this.onerror=null; this.src='https://placehold.co/400x600/1e1e1e/f5f5f5?text=Poster+Missing'">
                    
                    <!-- Favorite and Download Icons -->
                    <div class="absolute top-2 right-2 flex space-x-1 z-30 opacity-0 group-hover:opacity-100 transition duration-300">
                        <!-- Favorite Icon (Heart) -->
                        <button class="p-1 rounded-full bg-black/50 text-white hover:bg-black/70 transition duration-200"
                                onclick="event.stopPropagation(); toggleFavorite(${movie.id}, '${movie.title}');" 
                                aria-label="Toggle Favorite">
                            <!-- Filled Heart SVG -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${favoriteIconFill} transition duration-150" viewBox="0 0 24 24">
                                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                            </svg>
                        </button>
                        <!-- Download Icon (Circle Arrow Down) -->
                        <button class="p-1 rounded-full bg-black/50 text-white hover:text-primary hover:bg-black/70 transition duration-200"
                                onclick="event.stopPropagation(); handleDownloadClick('${movie.title}');"
                                aria-label="Download Movie">
                            <!-- Download SVG (Arrow down to a line) -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                        </button>
                    </div>

                    <!-- Title Overlay -->
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent flex items-end p-3">
                        <h3 class="text-base font-bold text-white leading-tight">${movie.title}</h3>
                    </div>
                </div>
            `;
            return card;
        }
        
        function renderRow(container, movies) {
            container.innerHTML = '';
            movies.forEach(movie => {
                container.appendChild(renderMovieCard(movie));
            });
        }
        
        function renderGrid(container, movies, query) {
            container.innerHTML = '';
            container.classList.remove('hidden');

            const titleHtml = movies.length > 0
                ? `<h2 class="text-2xl font-bold mb-4">Search Results for "${query}"</h2>`
                : `<p class="text-xl text-gray-400 p-8">No results found for "${query}".</p>`;

            container.innerHTML = titleHtml;

            if (movies.length > 0) {
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 md:gap-6';
                
                movies.forEach(movie => {
                    grid.appendChild(renderMovieCard(movie, true));
                });
                container.appendChild(grid);
            }
        }
        
        function renderHomePage() {
            if (!currentUserId) return; 

            closeProfileScreen();
            closeNotificationScreen();

            searchResultsContainer.classList.add('hidden');
            heroBanner.classList.remove('hidden');
            trendingSection.classList.remove('hidden');
            scifiSection.classList.remove('hidden');

            const trendingMovies = MOCK_MOVIES.filter(m => m.category === 'Trending');
            const scifiMovies = MOCK_MOVIES.filter(m => m.category === 'Sci-Fi' || m.genre === 'Action');
            
            renderRow(movieRowTrending, trendingMovies);
            renderRow(movieRowSciFi, scifiMovies);
        }

        function filterMovies() {
            if (!currentUserId) return; 

            const query = searchInput.value.toLowerCase().trim();
            
            if (query.length === 0) {
                renderHomePage();
                return;
            }
            
            closeProfileScreen();
            closeNotificationScreen();

            heroBanner.classList.add('hidden');
            trendingSection.classList.add('hidden');
            scifiSection.classList.add('hidden');
            
            const filtered = MOCK_MOVIES.filter(movie =>
                movie.title.toLowerCase().includes(query) ||
                movie.genre.toLowerCase().includes(query) ||
                movie.description.toLowerCase().includes(query)
            );
            
            renderGrid(searchResultsContainer, filtered, query);
        }

        function handleDownloadClick(movieTitle) {
            showTempMessage(`Starting download for "${movieTitle}". You will be notified when it's ready!`);
        }

        // --- Video Player Functions (omitted for brevity, assume unchanged) ---
        
        function formatTime(seconds) {
            const date = new Date(null);
            date.setSeconds(seconds);
            return date.toISOString().substr(14, 5); // Returns MM:SS format
        }

        function togglePlayPause() {
            if (!videoElement) return;

            const playIcon = document.getElementById('playIcon');
            const pauseIcon = document.getElementById('pauseIcon');

            if (videoElement.paused || videoElement.ended) {
                videoElement.play();
                if (playIcon) playIcon.classList.add('hidden');
                if (pauseIcon) pauseIcon.classList.remove('hidden');
            } else {
                videoElement.pause();
                if (playIcon) playIcon.classList.remove('hidden');
                if (pauseIcon) pauseIcon.classList.add('hidden');
            }
        }

        function toggleMute() {
            if (!videoElement) return;

            const volumeHigh = document.getElementById('volumeHigh');
            const volumeMute = document.getElementById('volumeMute');

            videoElement.muted = !videoElement.muted;
            if (videoElement.muted) {
                if (volumeHigh) volumeHigh.classList.add('hidden');
                if (volumeMute) volumeMute.classList.remove('hidden');
            } else {
                if (volumeHigh) volumeHigh.classList.remove('hidden');
                if (volumeMute) volumeMute.classList.add('hidden');
            }
        }
        
        function setVolume() {
            if (!videoElement) return;
            
            const volumeBar = document.getElementById('volumeBar');
            const volumeHigh = document.getElementById('volumeHigh');
            const volumeMute = document.getElementById('volumeMute');

            if (!volumeBar) return;
            
            videoElement.volume = volumeBar.value / 100;
            if (videoElement.volume === 0) {
                 videoElement.muted = true;
                 if (volumeHigh) volumeHigh.classList.add('hidden');
                 if (volumeMute) volumeMute.classList.remove('hidden');
            } else {
                 videoElement.muted = false;
                 if (volumeHigh) volumeHigh.classList.remove('hidden');
                 if (volumeMute) volumeMute.classList.add('hidden');
            }
        }

        function seekVideo() {
            if (!videoElement) return;
            const progressBar = document.getElementById('progressBar');
            if (!progressBar) return;
            
            const seekTime = (progressBar.value / 100) * videoElement.duration;
            videoElement.currentTime = seekTime;
        }

        function updateProgress() {
            if (!videoElement) return;

            const progressBar = document.getElementById('progressBar');
            const timeDisplay = document.getElementById('timeDisplay');
            
            if (!progressBar || !timeDisplay) return;

            const percent = (videoElement.currentTime / videoElement.duration) * 100;
            progressBar.value = percent || 0;
            
            const currentTime = formatTime(Math.floor(videoElement.currentTime));
            const duration = formatTime(Math.floor(videoElement.duration) || 0);
            timeDisplay.textContent = `${currentTime} / ${duration}`;
        }

        function toggleFullscreen() {
            if (!videoContainer) return;

            const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement;

            if (!isFullscreen) {
                if (videoContainer.requestFullscreen) {
                    videoContainer.requestFullscreen();
                } else if (videoContainer.webkitRequestFullscreen) { 
                    videoContainer.webkitRequestFullscreen();
                } else if (videoContainer.msRequestFullscreen) { 
                    videoContainer.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                }
            }
        }

        function setupVideoControls() {
            if (!videoElement) return;
            
            const playPauseButton = document.getElementById('playPauseButton');
            const muteButton = document.getElementById('muteButton');
            const volumeBar = document.getElementById('volumeBar');
            const progressBar = document.getElementById('progressBar');
            const fullscreenButton = document.getElementById('fullscreenButton');
            
            if (volumeBar) videoElement.volume = volumeBar.value / 100;
            
            if (playPauseButton) playPauseButton.addEventListener('click', togglePlayPause);
            if (muteButton) muteButton.addEventListener('click', toggleMute);
            if (volumeBar) volumeBar.addEventListener('input', setVolume);
            if (progressBar) progressBar.addEventListener('input', seekVideo);
            if (fullscreenButton) fullscreenButton.addEventListener('click', toggleFullscreen);

            videoElement.addEventListener('timeupdate', updateProgress);
            videoElement.addEventListener('loadedmetadata', updateProgress);
            videoElement.addEventListener('ended', () => {
                const playIcon = document.getElementById('playIcon');
                const pauseIcon = document.getElementById('pauseIcon');
                if (playIcon) playIcon.classList.remove('hidden');
                if (pauseIcon) pauseIcon.classList.add('hidden');
            });
        }
        
        function cleanupVideoControls() {
            if (!videoElement) return;

            const playPauseButton = document.getElementById('playPauseButton');
            const muteButton = document.getElementById('muteButton');
            const volumeBar = document.getElementById('volumeBar');
            const progressBar = document.getElementById('progressBar');
            const fullscreenButton = document.getElementById('fullscreenButton');

            if (playPauseButton) playPauseButton.removeEventListener('click', togglePlayPause);
            if (muteButton) muteButton.removeEventListener('click', toggleMute);
            if (volumeBar) volumeBar.removeEventListener('input', setVolume);
            if (progressBar) progressBar.removeEventListener('input', seekVideo);
            if (fullscreenButton) fullscreenButton.removeEventListener('click', toggleFullscreen);
            videoElement.removeEventListener('timeupdate', updateProgress);
            videoElement.removeEventListener('loadedmetadata', updateProgress);
            
            videoElement.pause();
            videoElement = null;
        }

        // --- Modal Handlers ---

        function openModal(movie) {
            if (!currentUserId) return; 
            
            closeProfileScreen();
            closeNotificationScreen();

            document.getElementById('modalTitle').textContent = movie.title;
            document.getElementById('modalYear').textContent = `Year: ${movie.year}`;
            document.getElementById('modalGenre').textContent = movie.genre;
            document.getElementById('modalDescription').textContent = movie.description;

            // Use the stored controls template here
            videoContainer.innerHTML = `
                <video id="playerVideo" src="${MOCK_VIDEO_URL}" class="rounded-t-xl" playsinline>
                    Your browser does not support the video tag.
                </video>
                ${CUSTOM_CONTROLS_HTML_STORE}
            `;
            
            videoElement = document.getElementById('playerVideo');
            setupVideoControls();

            movieModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            togglePlayPause();
        }

        function closeModal() {
            cleanupVideoControls();
            document.body.style.overflow = '';
            movieModal.classList.add('hidden');
        }

        // --- Event Listeners and Initial Load ---

        authForm.addEventListener('submit', (event) => {
            event.preventDefault();
            submitAuthForm();
        });

        searchInput.addEventListener('input', filterMovies);
        signInOutButton.addEventListener('click', handleSignOutOrAuthClick);
        installPromptButton.addEventListener('click', handleInstallClick); 
        
        // Modal and Hero Listeners
        closeModalButton.addEventListener('click', closeModal);
        toggleAuthModeButton.addEventListener('click', toggleAuthMode);
        heroPlayButton.addEventListener('click', () => openModal(MOCK_MOVIES.find(m => m.id === 1)));

        // Profile Screen Listeners
        profileButton.addEventListener('click', openProfileScreen);
        closeProfileButton.addEventListener('click', closeProfileScreen);
        profileSignOutButton.addEventListener('click', handleSignOutOrAuthClick);

        // Notification Screen Listeners
        notificationButton.addEventListener('click', openNotificationScreen);
        closeNotificationButton.addEventListener('click', closeNotificationScreen);

        // NEW Home Button Listener
        homeButton.addEventListener('click', goToHome);

        window.addEventListener('load', () => {
            // Store and remove the static video controls template
            const customControlsElement = document.getElementById('customControls');
            if (customControlsElement) {
                CUSTOM_CONTROLS_HTML_STORE = customControlsElement.outerHTML;
                customControlsElement.remove(); 
            }
            
            setupFirebase();
        });
    </script>
</body>
</html>
